---
title: "Estimating integrated photosynthesis using R-package dtPP"
author: "Karline Soetaert"
date: "04-October-2023"
output:
  pdf_document: default
  html_document: default
  word_document: 
abstract: 
keywords:
  photosynthesis, algae, aquatic science, PI curve, "R"
bibliography: 
  vignettes.bib 
vignette: >
  %\VignetteIndexEntry{Estimating integrated photosynthesis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include=FALSE}
options(width = 120)
require(dtPP)
toBibtex(citation("dtLife"))
toBibtex(citation("dtWad"))
toBibtex(citation("dtPP"))
toBibtex(citation("plot3D"))
toBibtex(citation("FME"))
```

# A complex example

This example uses measured irradiance data, fluctuating water levels, and time-varying PI-parameters. 

The integrated photosynthesis is estimated for a 4 -day period. 
The times for which we want to run the model is input in POSIXct data format.

```{r}
time <- seq(from = as.POSIXct("2021-08-01 01:00:00"), 
            to   = as.POSIXct("2021-08-05 01:00:00"), 
            by   = 60)  # output every minute
```

The light intensity has been obtained from the KNMI; they are stored in a data.frame called *Weather2021*.
The data from station Nr 235 are closest to the measurment site. 
The light values are called "radiation" in the dataset; they are in J/m2/s.

```{r}
st235   <- subset(Weather2021, 
                  subset = station==235)
It.data <- st235[, c("datetime", "radiation")]
```

water height varies in time (~tide)

```{r}
zmean       <- 5           # Mean height of water
t.period    <- 12.4*3600   # tidal period in seconds
t.amplitude <- 1           # tidal amplitude in meters

wH       <- t.amplitude * sin(2*pi*as.double(time)/t.period)
Ht.data  <- data.frame(t     = time, 
                       height= wH)
``` 

Photosynthesis parameters change over time. Assume that alpha and ps are Chl-specific values, so multiplying with chlorophyll gives the values to be used.

```{r}
Chl <- data.frame(time = as.POSIXct(c("2021-08-01 01:00:00", 
            "2021-08-02 01:00:00", "2021-08-03 01:00:00", 
            "2021-08-04 01:00:00", "2021-08-05 01:00:00")),
            conc = c(1, 2, 4, 3, 1))
```


```{r}
pars  = list(alpha = 0.02, eopt = 250, ps=0.5) # alpha, ps: Chl-specific value
PI.par <-   data.frame(
    time  = Chl$time,    
    alpha = pars$alpha*Chl$conc,   
    eopt  = 180, 
    ps    = pars$ps   *Chl$conc)   # Chl-specific value
```

Estimate depth integrated production

```{r}
PP <- integratedPP(zn      = zmean,   # water depth
                   times   = time,    # output time
                   It.data = It.data, # light intensity timeseries
                   kz      = 0.3,     # extinction coefficient
                   PI.par  = PI.par,
                   Ht.data = Ht.data) # water height (surface elevation)
```

```{r, fig.width=8, fig.height=8}
par(mfrow=c(3,2))
plot(PP, lwd=2, mfrow=NULL)
with(PP$ts, plot(times, alpha, 
                 xlab=" time", ylab="..", main="alpha", 
                 lwd=2, type="l", las=1))
with(PP$ts, plot(times, ps,
                 xlab=" time", ylab="..", main="ps", 
                 lwd=2, type="l", las=1))
```

