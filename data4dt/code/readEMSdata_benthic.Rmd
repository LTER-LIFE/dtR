---
title: "Reading and processing data for use in the LTER-LIFE digital twins: benthic data from the Ems"
author: "Karline Soetaert, and ...."
date: "first version: 27-02-2024; current version: `r format(Sys.time(), '%d %B %Y')`" 
output:
  pdf_document:
  word_document: default
  toc: yes
toc_depth: 3
word_document:
  toc: yes
abstract: This document prepares the BENTHIC photosynthesis and biogeochemical data from the Ems-Dollard 2013 campaigns performed by IMARES. The data were presented in a number of large spreadsheets where many calculations were done. The relevant data were exported from the spreadsheets as csv tables, read, and the outcome compared to the figures in the Ems-Dollard primary production report. Recovered datasets are complemented with attributes that describe the variables and stations sampled.
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
require(dtWad)
require(dtPP)
```

# Introduction

The data are from a Rijkswaterstaat-funded project "Research mud dynamics Ems Estuary". 

The aim of this project, carried out by Deltares and IMARES, was, amongst others to quantify measures to improve the ecological status of the estuary. For this end the current state (in 2012-2013) in terms of primary production was determined. The current report deals with  part of the IMARES work, focusing on the benthic primary production. Benthic data were only sampled in 2013.

These data are very well described in 

Brinkman, A.G., Riegman, R., Jacobs, P., Kuhn, S., Meijboom, A. 2015. Ems-Dollard primary production research: Full data report Report / IMARES Wageningen UR : C160/14, 629, IMARES Ecosystemen, 

available from (https://library.wur.nl/WebQuery/wurpubs/489709).

## Data availability

Two excel spreadsheets are available that hold the 2013 benthic data (photosynthesis parameters, benthic chlorophyll, abiotic conditions), and an extensive part of these data is presented as figures in the aforementioned report. 

# Function to read and plot benthic data

A function to read the csv files is created:

```{r}
readEms <- function(File, keep=NULL){
  Dir      <- "../raw_data/emsPI/benthic/"
  Data    <- read.csv2(file = paste(Dir, File, sep="/")) 
  if (ncol(Data) == 1)
    Data    <- read.csv(file = paste(Dir, File, sep="/")) 
  if (! is.null(keep))
    Data <- Data[,keep]
  Data
}
```


A function is made that reproduces the figures from the Brinkman et al., 2015 report.

```{r, warning=FALSE}
plotVals <- function(data,         # the dataset
                     stat = 1,     # name of station to be plotted
                     val  = 2,     # name of value to be plotted
                     std  = NULL,  # name of standard error to be plotted (if NULL: min-max)
                     main = paste("Station", stat), 
                     ylab = val, 
                     ...){
  
  # subset of the dataset
  dat  <- subset(data, subset=station == stat)
  
  # mean value (aggregated by the date)
  mean <- aggregate(x   = dat[, val], 
                    by  = list(dat[, "date"]), 
                    FUN = mean) 
  
  # use min-max
  if (is.null(std)){
    min <- aggregate(dat[, val], by=list(dat[, "date"]), FUN = min)[,2]
    max <- aggregate(dat[, val], by=list(dat[, "date"]), FUN = max)[,2]
  
  } else { # use standard error
      
    stdev <- aggregate(dat[, std], by=list(dat[, "date"]), FUN=mean, na.rm=TRUE)
    
    min <- mean[,2] - stdev[,2]
    max <- mean[,2] + stdev[,2]
  }
  
  # plot results, with either ranges or +- standard error
  
  yrange <- range(c(max, min), na.rm=TRUE)
  plot(mean[,1], mean[,2], 
       main = main, xlab = "time", ylab = ylab,
       type = "b", pch = 16, ylim = yrange, 
       ...)
  # error/min-max bars
  arrows(mean[,1], min, mean[,1], max, 
         code = 3, length = 0.02, angle = 90)
}

```

# Benthic stations 

The position of the benthic stations is given in the Brinkman et al (2015) report. The data were copy-pasted and put in a data.frame.
There were originally 6 stations, but station 2 could be sampled only once.

```{r}
bstat <- data.frame(station = paste("EDB0", c(1, 3:6), sep=""),
                    nr = c(1, 3:6),
                    longitude = c(6.78829, 6.94832, 7.08396, 
                                 7.15154, 7.17066),
                    latitude = c(53.46742, 53.39422, 53.313, 
                                  53.29703, 53.2566),
                    X = c(248045.3, 258848.6, 268083.6,
                          272630.6, 274016.6),
                    Y = c(609930.4, 602003.6, 593170.4, 
                          591501.7, 587034.5 ))

knitr::kable(bstat) 
```

```{r, fig.width=5, fig.height=5}
plotBathymetry(Wad_depth, xlim=c(6.5, 7.5), ylim=c(53.2, 53.6),
               main = "positions of benthic stations", 
               resfac=2)  # increase the resolution of the (crude) map

points(x   = bstat$longitude, 
       y   = bstat$latitude, 
       pch = 18, cex=3)

text  (x      = bstat$longitude, 
       y      = bstat$latitude, 
       labels = c(1, 3:6),
       col = "white", cex = 1.2)
```


# Chl and phaeophytine

Chlorophyll a (and phaeophytine) data were obtained from the spreadsheet "EDB_All_SheetsTogether_2014June30.xls".

Data were in sheet "chla B" (columns AW, AX for chlorophyll and Q and S for phaeophytine).

Note: the values for Phaeophytine are very high and probably are not good, these values are not used here.

Note that the chlorophyll has been determined on two replicates.

The chlorophyll concentrations are from the top 0.5 cm (?) 


```{r, fig.width=8, fig.height=10}
B_Chl <- readEms("B_Chl.csv") 
B_Chl <- B_Chl[ ,c("Station", "Date", "ug.chla.g_Sed", "ChlaSed_mgm2")]

B_Chl$Date <- as.Date(B_Chl$Date, format="%d/%m/%Y")

colnames(B_Chl) <- c("station", "date", "Chl_sed_ug.g", "Chl_sed_mg.m2")

# variable attributes
B_ChlVar <- data.frame(variable = c("Chl_sed_ug.g",   "Chl_sed_mg.m2"), 
                         unit   = c("ug Chl a/g sed", "mg Chl a/m2"),
                         method = c("Spectrophotometric measurements", 
                                    "Spectrophotometric - converted to areal, based on sediment density"),
                         description=c("Chlorophyll a concentration, per g bulk sediment in the top 0.5 cm", 
                                       "Sediment surface-integrated Chlorophyll a concentration (0.5 cm0"),
                         ref =  "https://library.wur.nl/WebQuery/wurpubs/489709")
summary(B_Chl)
attributes(B_Chl)$station   <- bstat
attributes(B_Chl)$variables <- B_ChlVar
```

The plot of benthic Chlorophyll is the same as figure 141 from Brinkman et al., 2015.

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(B_Chl, stat =1, val= "Chl_sed_mg.m2")
plotVals(B_Chl, stat =2, val= "Chl_sed_mg.m2")
plotVals(B_Chl, stat =3, val= "Chl_sed_mg.m2")
plotVals(B_Chl, stat =4, val= "Chl_sed_mg.m2")
plotVals(B_Chl, stat =5, val= "Chl_sed_mg.m2")
plotVals(B_Chl, stat =6, val= "Chl_sed_mg.m2")
```

These are the data in ug/g sediment.

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(B_Chl, stat =1, val= "Chl_sed_ug.g")
plotVals(B_Chl, stat =2, val= "Chl_sed_ug.g")
plotVals(B_Chl, stat =3, val= "Chl_sed_ug.g")
plotVals(B_Chl, stat =4, val= "Chl_sed_ug.g")
plotVals(B_Chl, stat =5, val= "Chl_sed_ug.g")
plotVals(B_Chl, stat =6, val= "Chl_sed_ug.g")

```

# Porosity

It is difficult to find porosity values. In excel sheet "benthic PP.xls", on sheet 2, column W, it says "Water_Vol_Fract", and this is estimated as volume of water / (volume of water +  volume of sediment). Although it is not clear where these data come from, they are taken as a measure of "porosity".

There are only few values, so they are hard-coded

```{r}
Sed_poro <- data.frame(station = c(1, 1, 3, 4, 5, 6, 6),
porosity = c(0.3941, 0.3952, 0.4285, 0.5016, 0.4076, 0.6091, 0.6322))

knitr:: kable (aggregate(x  = Sed_poro$porosity, 
                         by = list(Sed_poro$station),
                         FUN = mean))
```


# Benthic composition

Benthic algal species composition is measured with the "Benthotorch". 
This uses the intensity of chlorophyll fluorescence to estimate the different
algae in terms of green algae, blue‐green algae (cyanobacteria) and diatoms.

The data, in csv format were exported from sheet called "benthotorch" in file "EDB_All_SheetsTogether_2014June30.xls".

```{r}
B_algae <- readEms("Bentho_torch.csv") 
cn      <- colnames(B_algae)
B_algae <- B_algae[, c("Station", "Date", "Bottom.temp.C", 
                       "Green.ug.cm2.", "Diatoms.ug.cm2.",
                       "Cyano.ug.cm2.")]
colnames(B_algae) <- c("station", "date", "Temperature_Sed", 
                       "GreenAlgae_Sed_ug.cm2", 
                       "Diatoms_Sed_ug.cm2","Cyano_Sed_ug.cm2")

B_algae      <- B_algae[-which(is.na(B_algae$GreenAlgae_Sed_ug.cm2)),]
B_algae$date <- as.Date(B_algae$date, format="%d/%m/%Y")

# variable attributes
B_algaeVar <- data.frame(
           variable = c("Temperature_Sed", "GreenAlgae_Sed_ug.cm2", 
                        "Diatoms_Sed_ug.cm2","Cyano_Sed_ug.cm2"), 
           unit     = c("dgC", rep("ug Chl a/cm2 sed", times=3)),
           method   = c("Thermometer", 
                      rep("bentho torch (bbe Moldaenke, Germany)", times=3)),
           ref = rep("https://library.wur.nl/WebQuery/wurpubs/489709", times=4),
           description = c("Temperature in top sediment layer",
                           "Chlorophyll a in green algae, in top sediment layer", 
                           "Chlorophyll a in diatoms, in top sediment layer",
                           "Chlorophyll a in cyanobacteria, in top sediment layer"))
summary(B_algae)
attributes(B_algae)$station   <- bstat
attributes(B_algae)$variables <- B_algaeVar
```

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(B_algae, stat =1, val= "Diatoms_Sed_ug.cm2")
plotVals(B_algae, stat =2, val= "Diatoms_Sed_ug.cm2")
plotVals(B_algae, stat =3, val= "Diatoms_Sed_ug.cm2")
plotVals(B_algae, stat =4, val= "Diatoms_Sed_ug.cm2")
plotVals(B_algae, stat =5, val= "Diatoms_Sed_ug.cm2")
plotVals(B_algae, stat =6, val= "Diatoms_Sed_ug.cm2")
```

# Benthic PI data

Primary production was measured with the 14C technique, from radioactive bicarbonate uptake during 2 hour incubations in a series of light intensities, ranging from 0 to 1400 uE/m2/s. The raw data are available; they are fitted with the Eilers-Peeters model.

The PI data were obtained from the "EDB_All_SheetsTogether_2014June30.xls", a sheet called "14Cuptake".
The duration of each experiment (about 2 hours) was also exported (from sheet "dpm".

The key to the stations is in the sheet called InBasic from the same spreadsheet, and from the spreadsheet "Verzamel 14C data EDP 2013 h.xls" (this has been exported as basicstats.csv and basicstats2.csv).

For each PI set, the average chlorophyll was added, and the duration of the experiment (around 2 hours). 
From the main input, also the chlorophyll concentration of the sediment slurries was available. The chlorophyll and duration of the experiment was saved in the attribute called "experiment".

```{r}
# The meaning of the station numbers
camp    <-  readEms("basicstats.csv") 

# PI data and duration of the experiments
B_PI    <- readEms("B_PI.csv") 
B_PI$nr <- 1: nrow(B_PI)

# add station number and date
BPI  <- merge(camp, B_PI, by.x=c("Code"), by.y=c("Locatie"), all.y=TRUE)

BPI <- BPI[order(BPI$Station, BPI$nr),]

# duration of experiment in hours
ExpCond <- read.csv2(file = "../raw_data/emsPI/benthic/B_PI_time.csv")  

ExpCond <-  unique(
               merge(BPI[,c("Code","Date","Station","CHL.a.ug.l")], 
                     ExpCond, 
                     by = 1))[, -1]
colnames(ExpCond) <- c("station", "date","duration_hr", "Chl_in_C14_slurry_mg.L")


B_PI <- BPI[,c("Station", "Date", "uE.m.2.s.1", "mgC.mg.Chla.1.h.1", "mg.C.L.h.1")]

B_PI$Date <- as.Date(B_PI$Date, format="%d/%m/%Y")

colnames(B_PI) <- c("station", "date", "I", "Prod_gC.gChl.h", "Prod_gC.m3.h")
B_PIVar <- data.frame(
         variable = c("I", "Prod_gC.gChl.h",  "Prod_gC.m3.h"), 
         unit     = c("uE/m2/s", "mgC/mgChl/h",  "gC/m3/h"),
         method = c("light intensity", "C14 incorporation, corrected for Chl", 
                    "C14 measurement of slurry"),
         ref    = rep("https://library.wur.nl/WebQuery/wurpubs/489709", times=3),
         description = c("Light intensity administered during C14 incubation", 
                         "Chl-specific C14 production rate", 
                         "C14 production in water suspension"))
summary(B_PI)
attributes(B_PI)$station    <- bstat
attributes(B_PI)$variables  <- B_PIVar
attributes(B_PI)$experiment <- ExpCond
```

## Fitting the PI data

```{r, fig.width=8, fig.height=10}
ST_date <- unique(B_PI[, c("station", "date")])

B_PS_pars <- NULL
par(mfrow = c(4,3), las=1, mar=c(3,4,3,2))

istat = 1

for (i in 1:nrow(ST_date)){
  
  stat <- ST_date$station[i]
  if (istat != stat){   # Start a new figure
    par(mfrow = c(4,3), las=1, mar=c(3,4,3,2))
    istat <- stat
  }
  datum <- ST_date$date[i]
  data <- subset(B_PI, subset = station == stat &
                                date    == datum   )
  if (! any(is.na(data$Prod_gC.gChl.h))){
  FIT <- fitPI(model = "EP", I = data$I, response = data$Prod_gC.gChl.h)
  steFIT <- summary(FIT)$par[, "Std. Error"]
  
  B_PS_pars <- rbind(B_PS_pars,
                   with(FIT,
                   data.frame(station      = stat,
                              date         = datum,
                              alpha        = alpha,
                              eopt         = eopt,
                              ps           = ps,
#                              ps_gC.m3.h = ps/1000*data$Chl_sed_C14[1],
                              ste.alpha    = steFIT["alpha"],
                              ste.eopt     = steFIT["eopt"],
                              ste.ps       = steFIT["ps"],
                              rsquared     = r.squared(FIT)))
                   )
  plot(FIT, main= paste("Station", stat, "date", datum), 
                        ylim = c(0, FIT$ps*1.05), ylab="gC/gChl/h")
  legend("bottomright", ncol=2, 
         legend = c("alpha", "eopt", "ps", 
                    format(c(FIT$alpha, FIT$eopt, FIT$ps), digits=2)), cex=0.75)
  }
}

BPIparVar <- data.frame(variable = c("alpha", "eopt", "ps", 
                                    "ste.alpha", "ste.eopt", "ste.ps",
                            "rsquared"),
             unit =c("mg C /(mg chla)/ h /(uE/m2/s)", "uE/m2/s", "mg C/(mg chla)/h",  
                     "mg C /(mg chla)/ h /(uE/m2/s)", "uE/m2/s", "mg C/(mg chla)/h",  "-"),
             method = "fitting of Eilers-Peeters model to PI curves",

             description=c("Slope of the PI‐curve at zero light intensity (EP model)", 
                           "Optimal light intensity (EP model)", 
                           "Maximum phytobenthos primary productivity (EP model)", 
                           "standard error of fitted alpha", 
                           "standard error of fitted eopt",
                           "standard error of fitted ps", 
                           "r squared of the fit"),
             ref = rep("https://library.wur.nl/WebQuery/wurpubs/489709", times=7))

summary(B_PS_pars)
attributes(B_PS_pars)$station   <- bstat
attributes(B_PS_pars)$variables <- BPIparVar
```

## Checking the PI parameters

The plots of PI parameters alpha (Unit=mg C mg-1 chla h-1 (uE m-2 s-1)-1) and PBmax ((Unit=mg C mg-1 chla h-1) are similar to figure 177 and 178 from Brinkman et al., 2015. 


```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(B_PS_pars, stat =1, val= "alpha", std= "ste.alpha", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =2, val= "alpha", std= "ste.alpha", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =3, val= "alpha", std= "ste.alpha", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =4, val= "alpha", std= "ste.alpha", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =5, val= "alpha", std= "ste.alpha", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =6, val= "alpha", std= "ste.alpha", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
```

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(B_PS_pars, stat =1, val= "ps", std= "ste.ps", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =2, val= "ps", std= "ste.ps", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =3, val= "ps", std= "ste.ps", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =4, val= "ps", std= "ste.ps", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =5, val= "ps", std= "ste.ps", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =6, val= "ps", std= "ste.ps", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
```

We also show the values of eopt:

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(B_PS_pars, stat =1, val= "eopt", std= "ste.eopt", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =2, val= "eopt", std= "ste.eopt", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =3, val= "eopt", std= "ste.eopt", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =4, val= "eopt", std= "ste.eopt", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =5, val= "eopt", std= "ste.eopt", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
plotVals(B_PS_pars, stat =6, val= "eopt", std= "ste.eopt", 
         xlim=as.Date(c("2013-01-01", "2013-12-31")))
```

# Saving the data

## Merging PI parameters with Chlorophyll

```{r}
# the mean and std error for Chl for each (station x date) combination is taken first
Chl <- aggregate(x   = cbind(B_Chl$Chl_sed_mg.m2, B_Chl$Chl_sed_ug.g),
                 by  = list(B_Chl$station, B_Chl$date), 
                 FUN = mean)
colnames(Chl)[3: 4] <- c("Chl_sed_mg.m2", "Chl_sed_ug.g")

Chl.s <- aggregate(x = cbind(B_Chl$Chl_sed_mg.m2, B_Chl$Chl_sed_ug.g),
                 by  = list(B_Chl$station, B_Chl$date), 
                 FUN = function(x) sd(x)/sqrt(length(x)))
colnames(Chl.s)[3:4] <- c("ste.Chl_sed_mg.m2", "ste.Chl_sed_ug.g")

Ems_B_PS <- merge(B_PS_pars, Chl, 
                by = 1:2, all = TRUE)
Ems_B_PS <- merge(Ems_B_PS, Chl.s, 
                by = 1:2, all = TRUE)

PSvar <- rbind(BPIparVar, B_ChlVar)
             
datasource   <- "WUR (IMARES), commissioned by Rijkswaterstaat"
attr(Ems_B_PS, "variables")  <- PSvar
attr(Ems_B_PS, "stations")   <- bstat
attr(Ems_B_PS, "datasource") <- datasource
attr(Ems_B_PS, "file") <- "EDB_All_SheetsTogether_2014June30.xls"                          
attr(Ems_B_PS, "processing") <- paste(
  "merged photosynthesis parameters with benthic Chl at",
   Sys.time())

class(Ems_B_PS) <- c("dtLife", "data.frame")
save(file= "../processed_data/Ems_B_PS.rda", Ems_B_PS)

```

```{r}
save (file="../processed_data/B_Chl.rda",     B_Chl)
save (file="../processed_data/B_PI.rda",      B_PI)
save (file="../processed_data/B_PS_pars.rda", B_PS_pars)
save (file="../processed_data/B_algae.rda",   B_algae)
```

# Estimating photosynthesis for station 1 - oversimplified.

## Forcing function light

As this is for testing only, we pick a timeseries from the R-package dtWad.
The timeseries is for 2021 -  we make it applicable for 2013 

This should use real data rather than the made up data!

The dataset provides hourly data - the light is converted from J/m2/s to uEinst/m2/sec; the albedo is taken into account and it is assumed that only a fraction of the light is in the Photosynthetically active radiation (PAR).

```{r}

light <- subset(Wad_weather, 
                subset = station == 235)[, c("datetime", "radiation")]

# shift the date with 8 year (to make it 2013 rather than 2021)
light$datetime <- light$datetime - 365*86400*8

# Convert light from J/m2/s to uEinst/m2/s; a fraction of light is PAR (0.4), 
# take into account albedo
albedo = 0.05
light$par = light$radiation*(1-albedo)*4.6*0.4
```

## Sediment 

One centimeter of sediment is subdivided in 100 slices.

```{r}
# Sediment depth: 0.25 cm = 0.0025m
maxdepth  <- 0.0025   # m
nlayer    <- 100
depth.int <- seq(0, maxdepth, length.out=nlayer+1)
depth     <- 0.5*(depth.int[-1]+depth.int[-(nlayer+1)])
dz        <- diff(depth.int)
```

## Photosynthesis data

First subset the dataset for station 1

```{r}
PI_1      <- subset(Ems_B_PS, subset = station == 1)[,-1]
PI_1$Date <- as.POSIXct(PI_1$date)
```

## Chlorophyll

Chlorophyll changes over depth and in time.

Also, the units of the chlorophyll data are not compatible with the units of the PI parameters. 
More specifically:

* The maximum photosynthesis parameters *ps* has units of $mgC~mgChl^{-1}h^{-1}$. 
* The chlorophyll data are in $ug ~g^{-1} solid$ (or  $mg ~kg^{-1} solid$). 
* Units of Chlorophyll need to be in $mg~m^{-3} bulk$ sediment. 
Multiplying with *ps* will then give rates in $mgC ~m^{-3} bulk~h^{-1}$. 
* Adding these photosynthesis rates in each layer, multiplied with the layer thickness then will give depth-integrated rates in $mgC~m^{-2}~h^{-1}$. 


### Chlorophyll units:

To convert from $mg ~kg^{-1} solid$ to $mg~m^{-3} bulk$, 
we need to multiply with the bulk sediment density. This is calculated from the porosity:

* sediment bulk density = sediment dry density * (1-porosity)
* $kg~m^{-3}bulk$ = $kg~m^{-3}dry$ * $m^{-3}solid~(m^{-3}bulk)^{-1}$

For the sediment dry density we take 2500 $kg~m^{-3}$; the porosity for this station is around 0.4.

```{r}
# Chl is in microgram/g dry sediment -> convert to mg/m3 bulk
# for first 1 cm, equally distributed.
# Assume porosity = 0.7; sediment dry density = 2.5 g/cm3
# 1000 ug/cm3 = mg/m3

por <- subset(Sed_poro, subset=station == 1)
por <- mean(por$porosity)
por

ug.g2mg.m3 <- 2300*(1-por)   # conversion factor from ug/g to mg/m3
```

## Chlorophyll profile

Chlorophyll concentration is restricted to the upper 0.25 cm of the sediment only. 
We assume that Chlorophyll is exponentially declining over this 0.25 cm

```{r}
# A function to estimate the chlorophyll distribution over the sediment
# either a constant concentration, or exponentially declining
# The return value is such that the integrated concentration is = input C
Cprofile <- function(C,     # Mean concentration over depth zn
                     zn,    # depth over which the concentration was estimated
                     
                     z,     # depth at which concentration should be estimated
                     k=0    # decline rate, /m   - 0 = constant concentration
) {

  C0     <- k * C * zn/ (1-exp(-k*zn))  # concentration at surface
  Cz     <- C0 * exp(-z * k)  # *(z < zn)  Profile
  
  Cz
}

Cprofile.gauss <- function(C,    # Mean concentration over depth zn
                     zn,         # depth over which the concentration was estimated
                     
                     z,          # depth at which concentration should be estimated
                     zmax=zn/2,  # depth where conc is maximal
                     zstd=zn/10  # standard deviation around zmax
) {
  zi <- seq(0, zn, length.out=1000)
  dz <- diff(zi)
  zm <- 0.5*(zi[-1] + zi[-1000])
  Ci <- dnorm(zi, mean=zmax, sd=zstd)
  Cm <- 0.5*(Ci[-1] + Ci[-1000])
  
  Csum <- sum(Cm*dz)  # concentration at surface
  Cfac <- C/Csum
  
  dnorm(z, mean=zmax, sd=zstd)*Cfac
}

```

```{r}
# estimate concentration of Chl in each depth layer
kChl <- 1000   # /m, exponential decrease factor
Chl2D <- outer(X = PI_1$Chl_sed_ug.g*ug.g2mg.m3,     # Chl in mg/m3
               Y = depth,                            # depth for PP estimation
               FUN = function(Chl.t, depth) 
                    Cprofile(C  = Chl.t, 
                             z  = depth, 
                             zn = 0.0025, 
                             k  = kChl ))

t.chl <- PI_1$date
d.chl <- depth
```

The timeseries of photosynthesis parameters are merged with the Chlorophyll data to form a list

```{r}
PI_alpha <- PI_1$alpha*Chl2D                          # mg C /m3/ h /(uE/m2/s)
PI_ps    <- PI_1$ps*Chl2D                             # mg C /m3/ h 
PI_eopt  <- PI_1$eopt * matrix(nrow  = length(t.chl), # (uE/m2/s)
                               ncol  = length(d.chl), 
                               byrow = TRUE,
                               data  = 1)
PIpars <- list(time = as.POSIXct(t.chl), depth = d.chl,
               alpha = PI_alpha, 
               eopt  = PI_eopt, 
               ps    = PI_ps)
```

Estimate PP

```{r, fig.width=8, fig.height=10}
kd    <- 5000  # extinction per m

# calculate production for hourly values, from first to last observation
times <- seq(from = min(as.POSIXct(PI_1$date)),
             to   = max(as.POSIXct(PI_1$date)),
             by   = 3600)

PP <- integratedPP(
           zi       = depth.int,
           times    = times, 
           It.data  = light[, c("datetime", "par")],
           PI.par   = PIpars,
           kz       = kd,
           avgOver = "day"
                  )
plot(PP, mass="mgC", length="m", time="h")
plot(PP, which = "profile", mass="mgC", length="m", time="h")

summary(PP$ts)
mean(PP$ts$PP)* 24*365/1000 # gC/m2/yr
```

