---
word_document:
  toc: yes
author: "Karline Soetaert"
date: "first version: 01-10-2023; current version: `r format(Sys.time(), '%d %B %Y')`"
output:
  word_document: default
  pdf_document: null
  toc: yes
toc_depth: 3
title: "Reading and processing data for use in the LTER-LIFE digital twins: the NIOZ
  jetty data"
abstract: This document prepares the biogeochemical data from the NIOZ jetty that
  are to be used in the LTER life dtPP (digital twin of primary production) package.
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
require(dtWad)
```

# The jetty biogeochemical data (Phillipart, NIOZ)

This is a long-term biogeochemical data set from the surface waters at the NIOZ jetty. 

## Raw data

The data are presented in csv format, and are read with function *read.csv*.

```{r}
jetty <- read.csv("../raw_data/nioz/HW_MP_set.csv")
summary(jetty[,-(1:2)])
```

## Cleaning the jetty data

The following changes were done on the raw data:

1. The summary of the raw data show that the DIC data are problematic: 
the data should lie within 2000-2500, but have many values <100 and also values > 20000.

These data are modified so that their value is always within 2000-2500.
Note that the DIC data should be used with caution; they are probably measured with different devices.

2. The negative concentrations (NO3: `r length(which(jetty$NO3<0))`, 
NH4  `r length(which(jetty$NH4<0))`, Si:  `r length(which(jetty$Si<0))`, and 
DOP  `r length(which(jetty$DOP<0))`) are removed.

3. The column called "X" and the NPratio are removed (the latter can easily be estimated).

4. The time is changed to *POSIXct* format. 

5. Some columns are renamed

6. A description to each variable, and the station position, is added to the objects attributes.

```{r}
# Cleaning the aberrant DIC data
DIC                     <- jetty$DIC
DIC[which(DIC < 200)]   <- DIC[which(DIC<200)]*100
DIC[which(DIC > 20000)] <- DIC[which(DIC>20000)]/10
jetty$DIC <- DIC

# remove the column called "X"and NPratio 
Jetty <- jetty[,c("SampleID", "datetime", "T", "S", "SecchiDepth", "TN", "TP",
             "PO4",  "NO3", "NO2", "NH4", "DON", "DOP",  "Si", "DIC", "TSM", "Chl")]

# time to POSIXct format
Jetty$datetime <- as.POSIXct(Jetty$datetime)

# rename some columns
colnames(Jetty)[1:7] <- c("sampleID","datetime", "Temperature", "Salinity", "Secchi", "Ntot", "Ptot")
colnames(Jetty)[colnames(Jetty) == "TSM"] <- "SPM"

# add attributes to the data.frame

## Station position
stat <- list(station="NIOZjetty", longitude=4.789, latitude=53.002)

## variable description
desc <- data.frame(variable=c("Temperature", "Salinity",  "Secchi", "Ntot", "Ptot",
             "PO4",  "NO3", "NO2", "NH4", "DON", "DOP",  "Si", "DIC", "SPM", "Chl"),
             description=c("Water temperature", "Salinity", 
             "Max depth at which secchi disk is visible",
             "Total nitrogen concentration", 
             "Total phosphorus concentration", "Phosphate concentration", 
             "Nitrate concentration", "Nitrite concentration", 
             "Ammonium concentration", "Dissolved organic nitrogen",
             "Dissolved organic phosphorus concentration", 
             "Dissolved silicate concentration", 
             "Dissolved inorganic carbon concentration", 
             "Total suspended particulate matter", 
             "Chlorophyll concentration"), 
             
             unit=c("dgC", "-", "m", rep("mmol/m3", times=10), "mg/m3", "mg/m3"))

attr(Jetty, "station")     <- stat
attr(Jetty, "variables")   <- desc
attr(Jetty, "datasource")  <- "nioz"
attr(Jetty, "coordinates") <- c(lon=4.789, lat=53.002)
attr(Jetty, "format")       <- "wide"
class(Jetty) <- c("dtLife", "data.frame")
```

## The processed data

The final data set contains `r nrow(Jetty)` samples, 
ranging from `r as.Date(min(Jetty$datetime, na.rm=TRUE))` till  `r as.Date(max(Jetty$datetime, na.rm=TRUE))`.

The measured variables in this data set are:

```{r}
knitr::kable(desc, align='l')
```

The position of the NIOZ jetty data: 

```{r, fig.width=7, fig.height=5}
stat <- attributes(Jetty)$station[c("longitude", "latitude")]
plotBathymetry(Marsdiep, 
               pts=data.frame(longitude= stat$longitude, latitude=stat$latitude), 
               type = "image", NAcol="grey", pch=18, cex=5)
text(x=stat$longitude, y=stat$latitude, labels="Jetty", 
      col="white", font=2, cex=0.75)
```

As a final check all variables are plotted versus time

```{r, fig.width=10, fig.height=10}
par(mar=c(3,4,3,1))
plot(Jetty, type="l", mfrow=c(5,3))
```

The data.frame is saved in binary R format (rda file)

```{r}
save(file="../processed_data/Jetty.rda", Jetty)
```


\newpage

# References

The following R-sources were used for this work:

R-core:

* R Core Team (2022). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

R-package dtWad, 

* Soetaert K (2024). dtWad: Waddensea Digital Twin: general utilities. R package version 0.0.1.



