---
title: "Reading and processing pelagic data from the Ems"
author: "Karline Soetaert and ..."
date: "first version: 27-02-2024; current version: `r format(Sys.time(), '%d %B %Y')`" 
output:
  pdf_document:
  word_document: default
  toc: yes
toc_depth: 3
word_document:
  toc: yes
abstract: This document prepares the PELAGIC photosynthesis and biogeochemical data from the Ems-Dollard 2012-2013 campaigns performed by IMARES. Two sources of data were used. Some datasets were prepared by Deltares. They are the photosynthetic parameters, the (continuous) pocketbox data, algal composition and Rijkswaterstaat nutrient concentrations. The biogeochemical data from the monitoring are interpolated to match the IMARES data set. Other datasets were in spreadsheets. The relevant data were exported from the spreadsheets as csv tables; the data include the pigment and suspended matter concentrations, the C14 photosynthesis-irradiance  data, and the water-column extinction coefficients. The photosynthesis-irradiance data are fitted and compared to the dataset prepared by Deltares. Here we document the sources of the data, and create figures that can be compared with the figures from the IMARES report. Recovered datasets are complemented with attributes that describe the variables and stations sampled.
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
require(dtWad)
require(dtPP)
```

# Introduction

The Water Framework Directive (WFD) requires EU member states to achieve good ecological and chemical status of all designated water bodies (rivers, lakes, transitional and coastal waters) by 2015. 

Therefore Rijkswaterstaat Waterdienst has initiated the project "Research mud dynamics Ems Estuary". 

The aim of this project, carried out by Deltares and IMARES, is to (1) improve our knowledge on the mud dynamics in the Ems Estuary, (2) to identify the reasons for the increase in turbidity and (3) to quantify measures to improve the ecological status of the estuary.

The data unlocked in this report deal with the IMARES part of the project, focusing on pelagic primary production and associated water column data.

These data are very well described in 

Brinkman, A.G., Riegman, R., Jacobs, P., Kuhn, S., Meijboom, A. 2015. Ems-Dollard primary production research: Full data report Report / IMARES Wageningen UR : C160/14, 629, IMARES Ecosystemen, 

available from (https://library.wur.nl/WebQuery/wurpubs/489709).

## FAIR data.

Part of the biogeochemical data from stations in (and in the vicinity) of the Ems dollard of this project were made available by Deltares. These data were downloaded from the RWS website https://waterinfo-extra.rws.nl/download-data/

They are: 

* pelagic photosynthesis parameters, as measured during the project
* nutrient concentration data from the RWS monthly monitoring
* phytoplankton composition data
* CTD underway data.

## Uncleaned data

Only part of the pelagic data from the Brinkman et al. (2015) report are available from the above RWS sources.

However, two excel spreadsheets ("Verzamel 14C data ED 2012_Completed_Mar2014.xlsx" and "Verzamel 14C data EDP 2013 h.xlsx") are available that hold the 2012 and the 2013 pelagic data. Two other spreadsheets have the derived exinction coefficients.

Most of these data is presented as figures in the aforementioned report. 

# Function to read and plot the data

A function to read the csv files is created:

```{r}
readEms <- function(File, keep=NULL){
  Dir      <- "../raw_data/emsPI/pelagic/"
  Data    <- read.csv2(file = paste(Dir, File, sep="/")) 
  if (ncol(Data) == 1)
    Data    <- read.csv(file = paste(Dir, File, sep="/")) 
  if (! is.null(keep))
    Data <- Data[,keep]
  Data
}
```

A function is created that reproduces the figures from the Brinkman et al., 2015 report.

```{r, warnings=FALSE}
plotVals <- function(data,         # the dataset
                     stat = 1,     # name of station to be plotted
                     val  = 2,     # name of value to be plotted
                     std  = NULL,  # name of standard error to be plotted (if NULL: min-max)
                     main = paste("Station", stat), 
                     ylab = val, 
                     ...){
  
  # subset of the dataset
  dat  <- subset(data, subset=station == stat)
  
  # mean value (aggregated by the date)
  Mean <- aggregate(x   = dat[, val], 
                    by  = list(dat[, "date"]), 
                    FUN = mean, na.rm=TRUE) 
  Mean[is.nan(Mean[,2]),2] <- NA
  
  # use min-max
  if (is.null(std)){
    min <- aggregate(dat[, val], by=list(dat[, "date"]), FUN = min, na.rm=TRUE)[,2]
    max <- aggregate(dat[, val], by=list(dat[, "date"]), FUN = max, na.rm=TRUE)[,2]
    min[is.infinite(min)] <- NA
    max[is.infinite(max)] <- NA
  
  } else { # use standard error
      
    sterr <- aggregate(dat[, std], by=list(dat[, "date"]), FUN=mean, na.rm=TRUE)
    sterr[is.na(sterr)] <- 0    
    min <- Mean[,2] - sterr[,2]
    max <- Mean[,2] + sterr[,2]
  }
  
  # plot results, with either ranges or +- standard error
  
  yrange <- range(c(max, min), na.rm=TRUE)
  plot(Mean[,1], Mean[,2], 
       main = main, xlab = "time", ylab = ylab,
       type = "b", pch = 16, ylim = yrange, 
       ...)
  # error/min-max bars
  arrows(Mean[,1], min, Mean[,1], max, 
         code = 3, length = 0.02, angle = 90)
  abline(v=as.Date("2013-01-01"), lty=2, col="grey")
}
```

# Pelagic stations 

The position of the pelagic stations was recorded in the Deltares dataset.

```{r}
EmsPI    <- readEms("ed_fotosynthese_locations.csv") 

stations <- unique(EmsPI[, c("locatiecode", "geometriepuntx", 
                              "geometriepunty", "coordinatenstelsel")])

# locations are converted to wgs84, and columns are renamed
lat_lon   <- with(stations,
                  xy_to_wgs84(geometriepuntx, geometriepunty, 
                               EPSG = 28992))

stations  <- cbind(stations, lat_lon)

colnames(stations) <- c("station", "X", "Y", "EPSG", "longitude", "latitude")

stations$nr  <- 1:nrow(stations)  # sometimes the station number is given
stations     <- stations[, c("station", "longitude", "latitude", 
                             "X", "Y", "EPSG", "nr")]
row.names(stations) <- NULL

knitr::kable(stations, digits = c(3,3,3,0,0,0)) 
```

```{r, fig.width=5, fig.height=5}
plotBathymetry(Wad_depth, 
               xlim = c(6.0, 7.5), ylim = c(53.2, 53.6),
               main = "positions of pelagic stations", 
               resfac = 2)  # increase the resolution of the (crude) map

points(x   = stations$longitude, 
       y   = stations$latitude, 
       pch = 18, cex=3, col="grey")

text  (x      = stations$longitude, 
       y      = stations$latitude, 
       labels = stations$nr, # stations$station,
       col = "black", cex = 1)

legend("bottomleft", legend = c(1:6, stations$station), 
       ncol = 2, cex = 0.5)
```

## Keys to sample codes

Key to the sample codes is in two csv files called stations_2012.csv and stations_2013.csv

```{r}
keep <- c("Code", "Station", "Date")
Key  <- rbind(readEms("stations_2012.csv", keep),
              readEms("stations_2013.csv", keep))

Key$date <- as.Date(Key$Date, format="%d/%m/%Y")
Key$Date <- NULL
colnames(Key)[2] <- "nr"

Key <- merge(stations, Key, by = "nr")[, c("Code", "station", "date")]
```

# Chlorophyll and phaeophytine

Chlorophyll a and phaeophytine data were obtained from the two spreadsheets.

Data were in sheets called "In chla" (columns K, and M for chlorophyll and phaeophytine respectively).

Note that the chlorophyll and phaeophytine has been determined on two replicates.

```{r, fig.width=8, fig.height=10}
keep       <- c("Code", "chla_ug.L", "Phaeo_ug.L")
P_Chl_2012 <- readEms("Chl_2012.csv", keep)
P_Chl_2013 <- readEms("Chl_2013.csv", keep) 

P_Chl      <- rbind(P_Chl_2012, P_Chl_2013)
P_Chl      <- merge(Key  , 
                    P_Chl, 
                    by = "Code")[,-1]

colnames(P_Chl)[-(1:2)] <- c("Chla_ug.L", "Phaeo_ug.L")

# Some phaeophytine values are negative - they are removed
P_Chl$Phaeo_ug.L [P_Chl$Phaeo_ug.L < 0] <- NA

# variable attributes
P_ChlVar <- data.frame(variable = c("Chla_ug.L",   "Phaeo_ug.L"), 
                         unit   = c("ug Chl a/L water", "ug Phaeophytine/L water"),
                         method = c("Spectrophotometric measurements", 
                                    "Spectrophotometric measurements"),
                         ref = rep("https://library.wur.nl/WebQuery/wurpubs/489709", times=2),
                         description=c("Chlorophyll a concentration, per liter water", 
                                       "Phaeophytine concentration, per liter water"))
summary(P_Chl)
attributes(P_Chl)$station   <- stations
attributes(P_Chl)$variables <- P_ChlVar
```

The plot of pelagic Chlorophyll is the same as figure 110 and 111 from the Brinkman et al., 2015 report.

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(P_Chl, stat ="HUIBGOT",   val= "Chla_ug.L")
plotVals(P_Chl, stat ="RANSGZD",   val= "Chla_ug.L")
plotVals(P_Chl, stat ="DOEKGZD",   val= "Chla_ug.L")
plotVals(P_Chl, stat ="PAAPSSD",   val= "Chla_ug.L")
plotVals(P_Chl, stat ="MONDVDDLD", val= "Chla_ug.L")
plotVals(P_Chl, stat ="GROOTGTND", val= "Chla_ug.L")
```

# Suspended matter

SPM concentration were also present in the two spreadsheets, in sheets called "In-out SPM".

Note that these concentrations were also determined on two replicates.

For the report, the very high value of SPM in station 2 was removed, so we also replaced this value by NA.

```{r, fig.width=8, fig.height=10}
keep <- c("Code", "SPM_mg.L")
P_spm_2012 <- readEms("SPM_2012.csv", keep)
P_spm_2013 <- readEms("SPM_2013.csv", keep) 

P_SPM <- rbind(P_spm_2012, P_spm_2013)
P_SPM <- merge(Key  , 
               P_SPM, 
               by="Code")[,-1]

P_SPM$SPM_mg.L <- as.numeric(P_SPM$SPM_mg.L)
P_SPM$SPM_mg.L[P_SPM$SPM_mg.L > 1000] <- NA   # remove too high value

# variable attributes
P_SPMVar <- data.frame(variable = c("SPM_mg.L"), 
                         unit   = c("mg/L water"),
                         method = c("filtering and weighing"),
                         ref = rep("https://library.wur.nl/WebQuery/wurpubs/489709", times=2),
                         description=c("Suspended particulate matter concentration, per liter water"))
summary(P_SPM)
attributes(P_SPM)$station   <- stations
attributes(P_SPM)$variables <- P_SPMVar
```

The plot of pelagic spm is the same as figure 105 and 106 from Brinkman et al., 2015.

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(P_SPM, stat ="HUIBGOT",   val= "SPM_mg.L")
plotVals(P_SPM, stat ="RANSGZD",   val= "SPM_mg.L")
plotVals(P_SPM, stat ="DOEKGZD",   val= "SPM_mg.L")
plotVals(P_SPM, stat ="PAAPSSD",   val= "SPM_mg.L")
plotVals(P_SPM, stat ="MONDVDDLD", val= "SPM_mg.L")
plotVals(P_SPM, stat ="GROOTGTND", val= "SPM_mg.L")
```

# The photosynthesis-irradiance data

Primary production was measured with the 14C technique, from radioactive bicarbonate uptake during 2 hour incubations in a series of light intensities, ranging from 0 to 1400 uE/m2/s. 

The raw data are available from the two spreadsheets, in a sheet called "14Cuptake".

For each PI set, the average chlorophyll concentration was used to convret the rates (in mgC/L/hr) into chlorophyll-specific rates (mgC/mgChl/hour). The chlorophyll concentration used for this conversion was saved in the object's attribute called "experiment".

```{r}
keep <- c("Locatie", "Licht_uEm2s",  "Prod_mgC_mgChla_h",  "Prod_mgC_L_h")
P_PI_2012 <- readEms("PI_2012.csv", keep) 
P_PI_2013 <- readEms("PI_2013.csv", keep) 

P_PI     <- rbind(P_PI_2012, P_PI_2013)
P_PI$nr  <- 1 : nrow(P_PI)   # to restore the ordering later
P_PI     <- merge(Key  , 
                  P_PI , 
                  by.x = "Code", by.y = "Locatie")[,-1]

P_PI <- P_PI[order(P_PI$station, P_PI$nr),]

P_PI$Prod_mgC_L_h      <- as.numeric(P_PI$Prod_mgC_L_h)
P_PI$Prod_mgC_mgChla_h <- as.numeric(P_PI$Prod_mgC_mgChla_h)

# Chlorophyll concentration to save in experimental conditions (attribute)

ExpCond           <- na.omit(P_PI)
ExpCond$CHLa_ug_l <- 1000*ExpCond$Prod_mgC_L_h/ExpCond$Prod_mgC_mgChla_h
ExpCond$CHLa_ug_l[is.nan(ExpCond$CHLa_ug_l)] <- NA

ExpCond <- aggregate(ExpCond$CHLa_ug_l, 
                     by  = ExpCond[, c("station", "date")], 
                     FUN = mean, na.rm=TRUE)

colnames(ExpCond)[3] <- c("Chl_in_C14_incubation_ug.L")

P_PI      <- P_PI[,c("station", "date", "Licht_uEm2s", 
                     "Prod_mgC_mgChla_h", "Prod_mgC_L_h")]
colnames(P_PI)[-(1:2)] <- c("I", "Prod_gC.gChl.h", "Prod_gC.m3.h")

P_PI$date <- as.Date(P_PI$date, format="%d/%m/%Y")


# attributes
P_PIVar <- data.frame(variable = c("I", "Prod_gC.gChl.h",  "Prod_gC.m3.h"), 
                      unit     = c("uE/m2/s", "mgC/mgChl/h",  "gC/m3/h"),
                      method = c("light intensity", "C14 incorporation, corrected for Chl", 
                                 "C14 measurement of slurry"),
                      ref    = rep("https://library.wur.nl/WebQuery/wurpubs/489709", times=3),
                      description = c("Light intensity administered during C14 incubation", 
                                      "Chl-specific C14 production rate (water column)", 
                                      "C14 production rate (water column)"))
summary(P_PI)
attributes(P_PI)$station    <- stations
attributes(P_PI)$variables  <- P_PIVar
attributes(P_PI)$experiment <- ExpCond
```

## Fitting the PI data

The PI data are now fitted with the Eilers-Peeters model. Each fit is shown; the fitted parameters with their standard error are saved in a data.frame. 

```{r, fig.width=9, fig.height=10}

par(mfrow = c(5,4), las=1, mar=c(3,4,3,2))

# list of stations and dates
ST_date   <- unique(P_PI[, c("station", "date")])

# Loop over all samples
istat     <- 1
P_PS_pars <- NULL

for (i in 1:nrow(ST_date)){
  
  stat <- ST_date$station[i]
  
  if (istat != stat){   # Start a new figure
    par(mfrow = c(5,4), las = 1, mar = c(3,4,3,2))
    istat <- stat
  }
  
  datum <- ST_date$date[i]
  
  # subset the data from this sample
  data  <- subset(P_PI, subset = station == stat &
                                 date    == datum   )
  
  if (! any(is.na(data$Prod_gC.gChl.h))) {  # data are valid
    
    # fit it
    FIT    <- fitPI(model    = "EP", 
                    I        = data$I, 
                    response = data$Prod_gC.gChl.h)
    
    # standard error of the fit
    stFIT <- summary(FIT)$par[, "Std. Error"]
  
    P_PS_pars <- rbind(P_PS_pars,
               with(FIT,
                   data.frame(station      = stat,
                              date         = datum,
                              alpha        = alpha,
                              eopt         = eopt,
                              ps           = ps,
                              ste.alpha    = stFIT["alpha"],
                              ste.eopt     = stFIT["eopt"],
                              ste.ps       = stFIT["ps"],
                              rsquared     = r.squared(FIT)))
                      )
  
    plot(FIT, ylim = c(0, FIT$ps*1.05), 
         main = paste("Station", stat, "date", datum), 
         ylab = "gC/gChl/h")
    legend("bottomright", 
          legend = c("alpha", "eopt", "ps", 
             format(c(FIT$alpha, FIT$eopt, FIT$ps), digits=2)), 
          ncol = 2, cex = 0.75)
  }
}

# attributes
PIparVar <- data.frame(
     variable = c("alpha", "eopt", "ps", 
                  "ste.alpha", "ste.eopt", "ste.ps",
                   "rsquared"),
     unit = c("mg C /(mg chla)/ h /(uE/m2/s)", "uE/m2/s", "mg C/(mg chla)/h", 
              "mg C /(mg chla)/ h /(uE/m2/s)", "uE/m2/s", "mg C/(mg chla)/h",  
              "-"),
     method = "fitting of Eilers-Peeters model to PI curves",
     description = c("Slope of the PI‐curve at zero light intensity (EP model)", 
                     "Optimal light intensity (EP model)", 
                     "Maximum phytoplankton primary productivity (EP model)", 
                     "standard error of fitted alpha", 
                     "standard error of fitted eopt",
                     "standard error of fitted ps", 
                     "r squared of the fit"),
     ref = "https://library.wur.nl/WebQuery/wurpubs/489709")

summary(P_PS_pars)
attributes(P_PS_pars)$station   <- stations
attributes(P_PS_pars)$variables <- PIparVar
```


```{r, fig.width=8, fig.height=10}
par(mfrow=c(3,2), las=1)
plotVals(P_PS_pars, stat ="HUIBGOT", val= "alpha", std= "ste.alpha")
plotVals(P_PS_pars, stat ="RANSGZD", val= "alpha", std= "ste.alpha")
plotVals(P_PS_pars, stat ="DOEKGZD", val= "alpha", std= "ste.alpha")
plotVals(P_PS_pars, stat ="PAAPSSD", val= "alpha", std= "ste.alpha")
plotVals(P_PS_pars, stat ="MONDVDDLD", val= "alpha", std= "ste.alpha")
plotVals(P_PS_pars, stat ="GROOTGTND", val= "alpha", std= "ste.alpha")
```

```{r, fig.width=8, fig.height=10}
par(mfrow=c(3,2), las=1)
plotVals(P_PS_pars, stat ="HUIBGOT", val= "ps", std= "ste.ps")
plotVals(P_PS_pars, stat ="RANSGZD", val= "ps", std= "ste.ps")
plotVals(P_PS_pars, stat ="DOEKGZD", val= "ps", std= "ste.ps")
plotVals(P_PS_pars, stat ="PAAPSSD", val= "ps", std= "ste.ps")
plotVals(P_PS_pars, stat ="MONDVDDLD", val= "ps", std= "ste.ps")
plotVals(P_PS_pars, stat ="GROOTGTND", val= "ps", std= "ste.ps")
```

# The photosynthesis parameters from IMARES

The photosynthesis data were also fitted with the Eilers-Peeters model by Brinkman et al (2015); the fitted parameters were made available by Deltares; we use these data to compare with our fitted parameters. 

```{r}
EmsPI <-  readEms("ed_fotosynthese_locations.csv") 
```

Note that the dates in the Deltares-inputted data are one day later for 2012 than in the report. 
They are therefore changed, so that the dates match!

```{r}
# These are the dates that do not match
DDates <- as.Date(c("2012-03-07", "2012-03-21", "2012-04-04", "2012-04-18", "2012-05-04", "2012-05-16", "2012-06-02", "2012-06-15", "2012-07-03", "2012-07-17", "2012-08-01", "2012-08-14", "2012-08-29", "2012-09-13", "2012-09-27", "2012-10-12", "2012-10-26", "2012-12-12"))

# substract one day
DDnew <- DDates-1

EmsPI$tijdstip <- as.Date(EmsPI$tijdstip)
for (i in 1: length(DDates)){
  ii <- which(EmsPI$tijdstip == DDates[i])
  EmsPI$tijdstip[ii] <- DDnew[i]
}
```

Save the metadata of the measured variables

```{r}
PSvar <- unique(EmsPI[, c("wmrparameteroriginal", "WMR_eenheidcode", 
                          "waardebepalingsmethodeomschrijving")])
colnames(PSvar)   <- c("variable", "unit", "method")
PSvar$description <- "photosynthesis parameters measured by C14 incubations"

datasource <- "WUR (IMARES), commissioned by Rijkswaterstaat"
EPSG       <- 28992
file       <- "ed_fotosynthese_locations.csv"
```
  
Convert data to wide format (columns = parameters)

```{r}
PSsub <- EmsPI[, c("locatiecode", "tijdstip", 
                       "wmrparameteroriginal", "numeriekewaarde")]
colnames(PSsub) <- c("station", "datetime", "parameter", "value")

Ems_ps          <- dttowide(PSsub, swap = "parameter")
Ems_ps$Date     <- as.Date(Ems_ps$datetime)
P_PS_pars$Date  <- as.Date(P_PS_pars$date)
```

The comparison between the reported IMARES fit and ours shows that there are several fitted parameters that do not correspond.

```{r, fig.width=8, fig.height=8}
par(mfrow=c(2,2))
AA <- merge(Ems_ps, P_PS_pars, by = c("station", "Date"), all=TRUE)
AA$year <- format(AA$Date, "%Y") 
with(AA, plot(alfa, alpha, 
              main = "alpha", 
              xlab = "IMARES fit", ylab = "our fit", 
              col=as.factor(year)))
with(AA, plot(Imax, eopt, 
              main = "eopt", 
              xlab = "IMARES fit", ylab = "our fit", 
              col=as.factor(year)))
with(AA, plot(Pmax, ps, 
              main = "ps", 
              xlab = "IMARES fit", ylab = "our fit", 
              col=as.factor(year)))
plot.new()
legend("center", lty=1, col=c("black", "red"), legend = c(2012, 2013))
```

The parameters for which the two alpha values differ with more than 50% are extracted, and the fits of the two methods are compared. 

Based on this, it seems that all large deviations are from the 2013 fits, and especially for station PAAPSSD (station 4).

```{r, fig.width=8, fig.height=8}
ii <- which (abs(AA$alpha - AA$alfa)/AA$alpha > 0.5)
head(AA[ii, ], n=2)

par(mfrow=c(4,4))
I <- 1:1000
for (i in ii){
  FF <- AA[i, ]
  PIdata <- subset(P_PI, subset = station == FF$station  & 
                                  date    == FF$date  )  
  ltFIT <- fEP(I, p=c(FF$alpha, FF$eopt, FF$ps))
  imFIT <- fEP(I, p=c(FF$alfa,  FF$Imax, FF$Pmax))             
  
  ylim <- c(0, max(c(PIdata$Prod_gC.gChl.h., ltFIT[,2], imFIT[,2])))
  
  plot(PIdata$I, PIdata$Prod_gC.gChl.h, 
       ylim = ylim, xlim = c(0,1000),
       xlab = "light", ylab = "Prod_gC.gChl.h",
       main = paste(FF$station, FF$date))
  
  lines(ltFIT,   col="red")
  lines(imFIT, col="blue")
}
plot.new()
legend("center", lty=1, col = c("red", "blue"), 
       legend = c("current fit", "reported fit"))
```

Based on the above, it may be better to use the parameters derived here (red lines), rather than the parameters reported in Brinkman et al., 2015 (and compiled by Deltares).

```{r}
save(file= "../processed_data/P_PS_pars.rda", P_PS_pars)
```


# Extinction coefficients

Extinction coefficients were derived by Brinkman et al(2015) by fitting light-depth profiles from CTD data. 
These data were in spreadsheets called "ExtinctionParameters_comparison_2012.xls" and "ExtinctionParameters_comparison_2013.xls".

The columns called "kd_fin"	and	"kd_stderr" are used from these spreadsheets.

```{r}
kd_2012 <- readEms("kd_2012.csv") 
kd_2013 <- readEms("kd_2013.csv") 

kd_2012$date <- as.Date(kd_2012$datum)
kd_2013$date <- as.Date(kd_2013$datum, format="%d/%m/%Y")

Kd        <- rbind(kd_2012, kd_2013)
Kd$Kd     <- as.numeric(Kd$kd_fin)
Kd$ste.Kd <- as.numeric(Kd$kd_stderr)
Kd$nr     <-  as.integer(matrix(data = unlist(strsplit(Kd$locatie, "_")), 
                         ncol = 2, byrow = TRUE)[,2])
Kd        <- merge(Kd, 
                   stations[, c("nr", "station")])

Kd <- Kd[,c("station", "date", "Kd", "ste.Kd")]

kdVar <- rbind(c("Kd", "/m", "light - fitted", "https://library.wur.nl/WebQuery/wurpubs/489709", "water extinction coefficient"),
               c("ste.Kd", "/m", "light - fitted", "https://library.wur.nl/WebQuery/wurpubs/489709", "standard error of water extinction coefficient"))
colnames(kdVar) <- c("variable", "unit", "method", "ref", "description")

```

The plot of extinction coefficients is the same as figures 143 and 144 from Brinkman et al., 2015.

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow = c(3,2), las = 1)
plotVals(Kd, stat ="HUIBGOT",   val= "Kd")
plotVals(Kd, stat ="RANSGZD",   val= "Kd")
plotVals(Kd, stat ="DOEKGZD",   val= "Kd")
plotVals(Kd, stat ="PAAPSSD",   val= "Kd")
plotVals(Kd, stat ="MONDVDDLD", val= "Kd")
plotVals(Kd, stat ="GROOTGTND", val= "Kd")
```

# Nutrient data

The Nutrient data were made available by Deltares.

```{r}
Nutrients <- readEms("ed_nutrients_locations.csv") 

# attributes
nutvar    <- unique(Nutrients[, c("parametercode", "eenheidcode", 
                                   "waardebepalingsmethodeomschrijving")])
colnames(nutvar) <- c("variable", "unit", "method")

nutvar$method <- "RWS nutrient concentration"
nutvar$description <- "Concentrations interpolated from RWS monitoring, converted to mmol/m3"
nutvar$unit <- "mmol/m3"
nutvar$ref <- "https://library.wur.nl/WebQuery/wurpubs/489709"

# convert to wide format
Nutsub <- Nutrients[, c("locatiecode", "tijdstip", 
                        "wmrparameteroriginal", "numeriekewaarde")]
colnames(Nutsub) <- c("station", "datetime", "parameter", "value")
Nutdata <- dttowide(Nutsub, swap="parameter")

names(Nutdata)[2] <- "date"
Nutdata$date <- as.Date(Nutdata$date)
```

Nutrient data for each station are interpolated to the sampling times for the primary production.
Concentrations are converted to molar units, i.e. from mg/L to mmol/m3.

```{r}
N_mol  <- 1000/14.007
P_mol  <- 1000/30.973
Si_mol <- 1000/28.085

NUTS <- NULL
stdat <- unique(P_PI[, c("station", "date")])

for (st in unique(stations$station)) {
  NN    <- subset(Nutdata, subset = station==st)
  NP    <- subset(stdat,   subset = station==st)
  NH4_N <- approx(as.Date(NN$date), NN$NH4_N, xout=as.Date(NP$date))
  NO2_N <- approx(as.Date(NN$date), NN$NO2_N, xout=as.Date(NP$date))
  NO3_N <- approx(as.Date(NN$date), NN$NO3_N, xout=as.Date(NP$date))
  PO4_P <- approx(as.Date(NN$date), NN$PO4_P_mg.l, xout=as.Date(NP$date))
  SILI  <- approx(as.Date(NN$date), NN$SILI, xout=as.Date(NP$date))
  NUTS  <- rbind(NUTS, data.frame(station = st, 
                                  date    = NH4_N$x, 
                                  NH4  = NH4_N$y*N_mol, 
                                  NO2  = NO2_N$y*N_mol,
                                  NO3  = NO3_N$y*N_mol, 
                                  PO4  = PO4_P$y*P_mol,
                                  SiO2 = SILI$y *Si_mol))
}
```

Nutrient figures have to be compared with figures 85- from Brinkman et al., 2016. Note that they do not compare for 100%.


```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(NUTS, stat ="HUIBGOT", val= "SiO2")
plotVals(NUTS, stat ="RANSGZD", val= "SiO2")
plotVals(NUTS, stat ="DOEKGZD", val= "SiO2")
plotVals(NUTS, stat ="PAAPSSD", val= "SiO2")
plotVals(NUTS, stat ="MONDVDDLD", val= "SiO2")
plotVals(NUTS, stat ="GROOTGTND", val= "SiO2")
```

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(NUTS, stat ="HUIBGOT", val= "NH4")
plotVals(NUTS, stat ="RANSGZD", val= "NH4")
plotVals(NUTS, stat ="DOEKGZD", val= "NH4")
plotVals(NUTS, stat ="PAAPSSD", val= "NH4")
plotVals(NUTS, stat ="MONDVDDLD", val= "NH4")
plotVals(NUTS, stat ="GROOTGTND", val= "NH4")
```


```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(NUTS, stat ="HUIBGOT", val= "NO3")
plotVals(NUTS, stat ="RANSGZD", val= "NO3")
plotVals(NUTS, stat ="DOEKGZD", val= "NO3")
plotVals(NUTS, stat ="PAAPSSD", val= "NO3")
plotVals(NUTS, stat ="MONDVDDLD", val= "NO3")
plotVals(NUTS, stat ="GROOTGTND", val= "NO3")
```

```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(NUTS, stat ="HUIBGOT", val= "NO2")
plotVals(NUTS, stat ="RANSGZD", val= "NO2")
plotVals(NUTS, stat ="DOEKGZD", val= "NO2")
plotVals(NUTS, stat ="PAAPSSD", val= "NO2")
plotVals(NUTS, stat ="MONDVDDLD", val= "NO2")
plotVals(NUTS, stat ="GROOTGTND", val= "NO2")
```


```{r, fig.width=8, fig.height=10, warning=FALSE}
par(mfrow=c(3,2), las=1)
plotVals(NUTS, stat ="HUIBGOT", val= "PO4")
plotVals(NUTS, stat ="RANSGZD", val= "PO4")
plotVals(NUTS, stat ="DOEKGZD", val= "PO4")
plotVals(NUTS, stat ="PAAPSSD", val= "PO4")
plotVals(NUTS, stat ="MONDVDDLD", val= "PO4")
plotVals(NUTS, stat ="GROOTGTND", val= "PO4")
```

# Phytoplankton data

Phytoplankton data were also made available by Deltares:

```{r}
Algen  <- readEms("ed_algengroepen_locations.csv") 

# attributes
algvar.ext <- unique(Algen[, c("KBparameteroriginal",  "KBalgengroep", "eenheidcode", 
                           "waardebewerkingsmethodeomschrijving")])
colnames(algvar.ext) <- c("orig.variable", "algae group", "unit", "method")
algvar.ext$method <- "microscopic counts"

  
# convert to wide format
Algsub <- Algen[,c("locatiecode", "tijdstip", "KBparameteroriginal","numeriekewaarde")]
colnames(Algsub) <- c("station", "datetime", "parameter", "value")
Algdata <- dttowide(Algsub, swap="parameter")

use <- c("phytoCmass.l_Cyanophyta", "phytoCmass.l_Diatoms",  
         "phytoCmass.l_Dinophyceae", "phytoCmass.l_Flagellates.Other", 
         "Summ_Phyto_Cmass.l", "ug.Chla.l")

newnames <- c("Cyanophyta_pgC.l", "Diatoms_pgC.l",  
              "Dinophyceae_pgC.l", "Flagellates_Other_pgC.l", 
              "Summ_Phyto_pgC.l", "Summ_ug.Chla.l")
  
Algdata <- Algdata[,c("station", "datetime", use)]
names(Algdata)[-(1:2)] <- newnames
Algdata$datetime <- as.Date(Algdata$date)

algvar.ext <- subset(algvar.ext, subset=orig.variable %in% use)
algvar.ext <- merge(data.frame(variable=newnames, orig.variable = use), algvar.ext)
algvar <- algvar.ext[, c("variable", "unit", "method")]
algvar$description <- "algal groups derived by counting"
algvar$ref <- "https://library.wur.nl/WebQuery/wurpubs/489709"
```

# Abiotic conditions

The conditions of the water column in terms of oxygen, temperature, salinity are in the xls spreadsheet called "Verzamel 14C data EDP 2013 h.xls", in a sheet called "In T O2 sal".

These data have been exported as a csv file. 

Part of the data are from the HQ40D meter; the other part are from the Pocket box.

```{r}
Abiotics <- readEms("AbioticConditions.csv") 
cn       <- colnames(Abiotics)
cn[9:22] <- c("Salinity", "Temperature", "O2_mg.L",	"R1",	"R2", 
              "Salinity_PB", "Temperature_PB", "Oxygen_PB_umol.L",	
              "R3", "R4",	"Pel_Chla_Cyclops",	"Pel_Chla_AOA", "R5", "R6")
colnames(Abiotics) <- cn
Abiotics <- Abiotics[, -which(colnames(Abiotics) %in% c("R1", "R2", "R3", "R4", "R5", "R6"))]
```

From these data we choose the HQ40D data (this data is also used further in the spreadsheet), and the Chlorophyll measured with the AOA. Oxygen is converted from mg/L to mmol/m3

```{r}
O2_mol <- 1000/32 # mg/L to mmol/m3
Abiotics$O2 <- Abiotics$O2_mg.L * O2_mol
Abiotics <- Abiotics [, c("Station", "Date", "Time", "Temperature", "Salinity", "O2", "Pel_Chla_AOA")]
names(Abiotics)[1:3] <- c("station", "date", "time")
names(Abiotics)[names(Abiotics) == "Pel_Chla_AOA"] <- "Chl_Pel"

# attributes
AbioticsVar <- data.frame(variable=c("Temperature", "Salinity",  "O2", "Chl_Pel"), 
                         unit = c("dgC", "-", "mmol/m3", "ug/l"),
                         method = c("Hach HQ40 multimeter", "Hach HQ40 multimeter",
                                    "Hach HQ40 multimeter", "algae online analyser"),
                         ref = rep("https://library.wur.nl/WebQuery/wurpubs/489709", times=4),
                         description=c("water temperature from HQ40D", "water salinity from HQ40D", 
                                       "water oxygen from HQ40D", "water Chl from algae online analyser"))
```


# CTD underway data

Underway the water column was sampled for temperature, salinity, oxygen, and CDOM, Chlorophyll, turbidity. 

These data were also made availaibe by Deltares; the data close to the sampling stations is extracted.

Note: AOA = algae online analyser

```{r}
CTD    <- readEms("ed_pocketbox_locations.csv") 
select <- c("Temperature", "Salinity", "O2", "AOA-YellowSub", "Cyclops CDOM",
            "AOA-Chl_A", "Turbidity")
CTD <- subset(CTD, subset = wmrparameteroriginal %in% select)
CTDvar   <- unique(CTD[, c("wmrparameteroriginal",  "eenheidcode", 
                                   "bemonsteringsapparaatomschrijving")])
colnames(CTDvar) <- c("variable", "unit", "method")
CTDvar$description <- "derived from continuous measurement by pocketbox"
CTDvar$ref <- "https://library.wur.nl/WebQuery/wurpubs/489709"
CTDvar[CTDvar$variable=="O2", "unit"] <- "mmol/m3"
CTDvar[CTDvar$variable=="Salinity", "unit"] <- "-"
CTDvar[CTDvar$variable=="Temperature", "unit"] <- "dgC"

# convert to wide format
CTDsub <- CTD[,c("geometriepuntx", "geometriepunty", "tijdstip", 
                 "wmrparameteroriginal","numeriekewaarde")]
colnames(CTDsub) <- c("X", "Y", "datetime", "parameter", "value")
CTDdata <- dttowide(CTDsub[,-(1:2)], swap="parameter")
CTDdata$O2 <- CTDdata$O2 * 1000/32

CTDall <- merge(CTDdata, unique(CTDsub[,c("X", "Y", "datetime")]))
CTDall <- cbind(xy_to_wgs84(CTDall$X, CTDall$Y, EPSG=28992), CTDall)
colnames(CTDall)[3] <- "CTDdatetime"
```

find the data close to the sampling station

```{r}
stdat <- merge(stdat, stations)

untime  <- unique(stdat$date)
CTDDATA <- NULL

for (i in 1:length(untime)){
  tt <- as.Date(untime[i])
  #cat (tt , " ")
  ctd <- subset(CTDall, subset = as.Date(CTDdatetime) == tt | 
                                 as.Date(CTDdatetime) == tt-1)
  stt <- stdat[which(stdat$date == tt) ,]
  if (nrow(ctd)){
    ST1     <- outer(stt$X, ctd$X, FUN=function(x,y) (x-y)^2)
    ST2     <- outer(stt$Y, ctd$Y, FUN=function(x,y) (x-y)^2)
    ST      <- ST1+ST2
    ii      <- apply(ST, MARGIN=1, FUN=which.min)
    CTDDATA <- rbind(CTDDATA, cbind(stt, ctd[ii,]))
  } 
}
```

# merging all data

## Chlorophyll, spm, Kd and PI parameters

To merge the Chlorophyll and SPM data with the PI parameters and kd values, the mean and standarderror of the two replicates is estimated first.

```{r}
# the mean and std error for Chl and SPM for each (station x date) combination is taken first
Chl <- aggregate(x   = P_Chl$Chla_ug.L, 
                 by  = list(P_Chl$station, P_Chl$date), 
                 FUN = mean)
colnames(Chl)[3] <- "Chla_ug.L"

Chl.s <- aggregate(x   = P_Chl$Chla_ug.L, 
                 by  = list(P_Chl$station, P_Chl$date), 
                 FUN = function(x) sd(x)/sqrt(length(x)))
colnames(Chl.s)[3] <- "ste.Chl"

SPM <- aggregate(x   = P_SPM$SPM_mg.L, 
                 by  = list(P_SPM$station, P_SPM$date), 
                 FUN = mean)
colnames(SPM)[3] <- "SPM_mg.L"

SPM.s <- aggregate(x   = P_SPM$SPM_mg.L, 
                 by  = list(P_SPM$station, P_SPM$date), 
                 FUN = function(x) sd(x)/sqrt(length(x)))
colnames(SPM.s)[3] <- "ste.SPM"

P_PS_pars$Date <- NULL
Ems_PS <- merge(P_PS_pars, Chl, 
                by = 1:2, all = TRUE)
Ems_PS <- merge(Ems_PS, Chl.s, 
                by = 1:2, all = TRUE)
Ems_PS <- merge(Ems_PS, SPM, 
                by = 1:2, all = TRUE)
Ems_PS <- merge(Ems_PS, SPM.s, 
                by = 1:2, all = TRUE)
Ems_PS <- merge(Ems_PS, Kd, 
                by = 1:2, all = TRUE)

PSvar <- rbind(PIparVar, 
               P_ChlVar, P_SPMVar, kdVar)

attr(Ems_PS, "variables")  <- PSvar
attr(Ems_PS, "stations")   <- stations
attr(Ems_PS, "datasource") <- datasource
attr(Ems_PS, "file") <- c("Verzamel 14C data ED 2012_Completed_Mar2014.xlsx", 
                          "Verzamel 14C data EDP 2013 h.xlsx")                             
attr(Ems_PS, "processing") <- paste(
  "merged photosynthesis parameters with Chl, SPM and Kd at",
   Sys.time())
save(file= "../processed_data/Ems_PS.rda", Ems_PS)
```

## Biogeochemical data, CTD data and algal composition

```{r}
Ems_biogeo <- merge(NUTS, 
                    CTDDATA[,-c(2,3,5,6,7, 13,14)], 
                    by=1:2, all=TRUE)
Ems_biogeo <- merge(Ems_biogeo, 
                    Algdata, 
                    by=1:2, all=TRUE)

variables <- rbind(PSvar, CTDvar, nutvar, 
                   algvar)
attr(Ems_biogeo, "variables")  <- variables
attr(Ems_biogeo, "stations")   <- stations
attr(Ems_biogeo, "datasource") <- datasource
attr(Ems_biogeo, "file") <- c("ed_fotosynthese_locations.csv", 
                         "ed_nutrients_locations.csv",
                         "ed_algengroepen_locations.csv", 
                         "ed_pocketbox_locations.csv" )                             
attr(Ems_biogeo, "processing") <- paste(
  "merged photosynthesis parameters with nutrients, CTD data, algal information at",
   Sys.time())

Ems_biogeo$X <- Ems_biogeo$Y <- NULL

save(file= "../processed_data/Ems_biogeo.rda", Ems_biogeo)
```


# A first try on estimating photosynthesis.

## Forcing function light

As this is for testing only, we pick a timeseries from the R-package dtWad.
The timeseries is for 2021 -  we make it applicable for 2013 

This should use real data rather than the made up data!

The dataset provides hourly data - the light is converted from J/m2/s to uEinst/m2/sec; the albedo is taken into account and it is assumed that only a fraction of the light is in the Photosynthetically active radiation (PAR).

```{r}
light <- subset(Wad_weather, 
                subset = station == 235)[, c("datetime", "radiation")]

# shift the date with 8 year (to make it 2013 rather than 2021)
light$datetime <- light$datetime - 365*86400*8

# Convert light from J/m2/s to uEinst/m2/s (4.6)
# a fraction of light is PAR (0.4), 
# take into account albedo
albedo    = 0.05

light$par = light$radiation*(1-albedo)*4.6*0.4
head (light)
```

## Photosynthesis data

First subset the dataset for station HUIBGOT

```{r}
PI_1      <- subset(Ems_PS, subset = station == "HUIBGOT")[,-1]
PI_1$Date <- as.POSIXct(PI_1$date)
```

The photosynthesis parameters change over time;
alpha and ps are Chl-specific - they are multiplied with Chl

```{r}
PI_alpha <- data.frame(time  = PI_1$Date, 
                       alpha = PI_1$alpha*PI_1$Chla_ug.L)

PI_ps    <- data.frame(time  = PI_1$Date, 
                       ps    = PI_1$ps   *PI_1$Chla_ug.L)

PI_eopt  <- data.frame(time  = PI_1$Date, 
                       eopt  = PI_1$eopt)

PI_pars <- merge(PI_alpha, PI_ps,  
                 by = "time")
PI_pars <- merge(PI_pars, PI_eopt, 
                 by = "time")

head(PI_pars)
```

The extinction coefficient

```{r}
PI_Kd   <- data.frame(time  = PI_1$Date, 
                       Kd    = PI_1$Kd)
```


Estimate PP

```{r, fig.width=8, fig.height=10}
# calculate production for hourly values, from first to last observation
times <- seq(from = min(as.POSIXct(light$date)),
             to   = max(as.POSIXct(light$date)),
             by   = 3600)

PP <- integratedPP(
           zn       = 20,   # assume 20 meter deep
           times    = times, 
           It.data  = light[, c("datetime", "par")],
           PI.par   = PI_pars,
           kz       = PI_Kd,
           avgOver = "day"
                  )

plot(PP, mass="mgC", length="m", time="h")
```

```{r}
```

\newpage

# References

The following R-sources were used for this work:

R-core:

* R Core Team (2022). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

R-package dtWad, 

* Soetaert K (2024). dtWad: Waddensea Digital Twin: general utilities. R package version 0.0.1.

