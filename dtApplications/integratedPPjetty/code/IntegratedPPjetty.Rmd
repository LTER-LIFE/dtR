---
title: "Estimating integrated production : the NIOZ jetty"
author: "Karline Soetaert"
date: "first version: 13-January-2024; current version: `r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document: default
  html_document: default
  word_document: 
abstract: Integrated photosynthesis for the monitoring station at the NIOZ jetty is estimated. It merges (published) PI parameters with long-term data series of Chlorophyll, secchi depth and temperture at the Jetty, a time series of irradiance at the water surface from KNMI and with water height data from the Rijkswaterstaat. The calculations make use of functions of the R-package dtBioG of the LTER-Life project.
keywords:
  photosynthesis, chlorophyll, NIOZ Jetty, "dtPP", "R"
---

```{r setup, include=FALSE}
options(width = 120)
require(dtPP)
```

Phytoplankton Primary Productivity (PhytoPP) forms the base of the marine food chain and is therefore an important measure of ocean productivity.

The procedure for estimating depth integrated photosynthesis is exemplified based on a dataset of Chlorophyll, secchi depth and temperature from the NIOZ jetty (4.789 $^o$ E and 53.002 $^o$ N). Chlorophyll is used to scale the photsynthesis-irradiance parameters; temperature is required because the PI parameters Iopt and Pmax depend on temperature.

We also use a timeseries with photosynthetically active radiation (light intensity) data, and water height data.

# The NIOZ Jetty data

The Jetty data are part of the dtPP R-package.

```{r}
# --------------------------------
# Chlorophyll
# --------------------------------
# Chlorophyll conc for 2000-2020

ChlJetty <- subset(Jetty, 
                   subset = datetime >= as.POSIXct("1999-12-15") &
                            datetime <= as.POSIXct("2021-01-01"))

ChlJetty <- ChlJetty [, c("datetime", "Temperature", "Chl", "Secchi")]
```

```{r}
with(ChlJetty, plot(datetime, Temperature, type="l"))
```

# Irradiance

We use the weatherdata from station 235 (DE KOOY VK, 52.9269dgN,    4.7811 dgE) for irradiance. 

```{r, eval=FALSE}
dir <- "../raw_data"
files <- c("uurgeg_235_1991-2000.txt", "uurgeg_235_2001-2010.txt", 
           "uurgeg_235_2011-2020.txt")
Irradiance <- readKNMI(dir=dir, file = files)[,c("datetime", "radiation")]
Irradiance <- subset(Irradiance, 
                     subset = datetime >= as.POSIXct("2000-01-01") &
                              datetime <= as.POSIXct("2021-01-01"))

# 50% of irradiance = PAR
Irradiance$par <- Irradiance$radiation * 0.5
Irradiance$radiation <- NULL

save(file = "../processed_data/Irradiance.rda", Irradiance)
```

```{r, eval=TRUE}
load(file = "../processed_data/Irradiance.rda") #, Irradiance
```

```{r, fig.width=8, fig.height=8}
par(mfrow=c(2,1))

with(ChlJetty,{
  plot(datetime, Chl, type="l")
  plot(datetime, Temperature, type="l")
  
})
```

# Water height

Water heights are downloaded from a nearby station, OudeSchild (OUDSD, 4.850192, 53.03884).

```{r, eval=FALSE}
dir <- "../raw_data"
WH  <- readRWS(dir  = dir, 
               file = "20240113_008.csv")

# select the data for the year 2000-
WH  <- subset(WH, 
              subset = datetime >= as.POSIXct("2000-01-01") &
                       datetime <= as.POSIXct("2021-01-01"))

# average over 1 hour (was 10 min)
WHeightJetty <- average_timeseries(
                      input   = WH[ ,c("datetime", "Height")], 
                      avgOver = "hour", 
                      avgTime = 1, 
                      value   = "Height")

head(WHeightJetty)
save(file = "../processed_data/WHeightJetty.rda", WHeightJetty)
```

```{r, eval=TRUE}
load(file = "../processed_data/WHeightJetty.rda") #, WHeightJetty
```

# extinction coefficient 

 kz varies with time; assume relationship with Secchi:

```{r}
ChlJetty$kz <- 7/ChlJetty$Secchi  # in /m
```

# PI parameters

 values for alpha, eopt and ps are not available from the Waddensea

The values in Brinkman and Jacobs (2023) are used instead (approximately) 

 Brinkman & Jacobs, 2023. Gross pelagic primary production in the Ems-Dollard estuary,
 Journal of Sea Research 192 (2023) 102362

 alpha and ps are Chl-specific values -> they need to be multiplied with Chl
 at each time step

 eopt and ps depend on temperature

```{r}
# steepness of the light curve, mgC/mgChl/(uEinst/m2/s)
alpha <- 0.049  

# optimal light intensity (in uEinst/m2/s - original values in W/m2)
eopt  <- 4*(150 + 15*ChlJetty$Temperature)

# assumed temperature dependence for maximal gross production
ps    <- 13*1.06^(ChlJetty$Temperature-20)    # mgC/mgChl/h

# time-variable PI parameters
PI.par <- data.frame(time  = ChlJetty$datetime,
                     alpha = alpha*ChlJetty$Chl,
                     eopt  = eopt,
                     ps    = ps*ChlJetty$Chl)
```                     

# Position of the data

```{r, fig.width=6, fig.height=5}
datasource <- data.frame(
              orig = c("NIOZ", "KNMI", "RWS"),
              name = c("Jetty", "De Kooij", "OudeSchild"),
              x = c(4.789, 4.7811, 4.850192 ), 
              y = c(53.002, 52.9269, 53.03884))


plotBathymetry(Marsdiep, 
               pts    = datasource[,c("x", "y")], 
               ptlist = list(cex=4, col= "white"), NAcol="grey", type="image",
               main   = "Position of the data sets surrounding the NIOZ jetty")
text(datasource$x, datasource$y, labels=1:3, cex=0.7)
legend("bottomright", legend = c(1:3, datasource$name, datasource$orig), 
       ncol=3, cex=0.7)

```

# Integrated production

```{r}
# 20 years of data, hourly
times <- seq(from = as.POSIXct("2000-01-01"), 
             to   = as.POSIXct("2020-12-31"), 
             by   = 3600)

# integrated production, averaged over a day

times <- seq(from = as.POSIXct("2020-01-01"), 
             to   = as.POSIXct("2020-12-31"), 
             by   = 3600)

Pprod_day <- integratedPP(
                 zn      = 10,            # water depth
                 times   = times,
                 Ht.data = WHeightJetty,  # water height
                 PI.par  = PI.par,        # PI parameters
                 It.data = Irradiance,    # Light
                 kz      = ChlJetty[, c("datetime", "kz")],
                 avgOver = "day", 
                 avgTime = 1
)  

# integrated production, averaged over a year

Pprod_yr <- integratedPP(
                 zn      = 10,            # water depth
                 times   = times,
                 convFac = 1, 
                 Ht.data = WHeightJetty,  # water height
                 PI.par  = PI.par,
                 It.data = Irradiance,
                 kz      = ChlJetty[, c("datetime", "kz")],
                 avgOver = "year", 
                 avgTime = 1
)  
```

```{r, fig.width=8, fig.height=8}
plot(Pprod_day, mass="mgC", length="m", time="h")
```

```{r, fig.width=8, fig.height=8}
plot(Pprod_yr, mass="mgC", length="m", time="h")
```
